<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ZpDIC æ´¾ç”Ÿãƒ„ãƒ¼ãƒ« å®Œå…¨é€æ¬¡å‡¦ç†ç‰ˆ</title>
<style>
body{font-family:sans-serif;margin:20px;background:#f5f5f5;}
input,textarea,select,button{display:block;margin:8px 0;padding:6px;width:100%;max-width:500px;}
textarea{height:80px;}
pre{background:#fff;padding:10px;max-width:800px;overflow:auto;}
h2{margin-top:30px;}
</style>
</head>
<body>
<h1>ZpDIC æ“ä½œï¼†æ´¾ç”Ÿãƒ„ãƒ¼ãƒ«ã€æ©Ÿèƒ½ãƒ•ãƒ«ãƒ»å®‰å…¨é€æ¬¡æ´¾ç”Ÿç‰ˆã€‘</h1>

<label>APIã‚­ãƒ¼:</label><input id="apiKey">
<label>æ¬å…¥å£è¾æ›¸ID:</label><input id="inputDict">
<label>æ¬å‡ºå£è¾æ›¸ID:</label><input id="outputDict">

<hr><h2>ğŸ”¹ æ´¾ç”Ÿãƒ«ãƒ¼ãƒ«ç®¡ç†</h2>
<textarea id="derivationRules" placeholder="dâ†’t\naâ†’e ãªã©æ”¹è¡ŒåŒºåˆ‡ã‚Š"></textarea>
<input id="rulesetName" placeholder="ãƒ«ãƒ¼ãƒ«ã‚»ãƒƒãƒˆå">
<button onclick="saveRuleset()">ãƒ«ãƒ¼ãƒ«ã‚»ãƒƒãƒˆä¿å­˜</button>
<select id="rulesetSelect"></select>
<button onclick="loadRuleset()">é¸æŠå‘¼ã³å‡ºã—</button>
<button onclick="deleteRuleset()">é¸æŠå‰Šé™¤</button>

<label>å˜èªç•ªå·ç¯„å›²ï¼ˆä¾‹: 1-500ï¼‰:</label><input id="wordRange">
<button onclick="runDerivation()">æ´¾ç”Ÿé–‹å§‹</button>
<pre id="progress"></pre>

<hr><h2>ğŸ”§ å˜èªç·¨é›†ãƒ»æ¤œç´¢</h2>
<input id="editWordNumber" placeholder="å˜èªç•ªå·ï¼ˆæ–°è¦ã¯ç©ºï¼‰">
<input id="editWordName" placeholder="å˜èªå">
<input id="editPronunciation" placeholder="ç™ºéŸ³">
<input id="editVariations" placeholder="å¤‰åŒ–å½¢(|åŒºåˆ‡ã‚Š)">
<input id="editTags" placeholder="ã‚¿ã‚°(|åŒºåˆ‡ã‚Š)">
<textarea id="editInformations" placeholder="æƒ…å ± ã‚¿ã‚¤ãƒˆãƒ«|å†…å®¹ æ”¹è¡ŒåŒºåˆ‡ã‚Š"></textarea>
<button onclick="submitWord()">ä¿å­˜</button>
<button onclick="deleteWord()">å‰Šé™¤</button>
<button onclick="loadWord()">èª­ã¿è¾¼ã¿</button>
<pre id="wordResult"></pre>

<h3>ğŸ” å˜èªæ¤œç´¢</h3>
<input id="searchText" placeholder="æ¤œç´¢èª">
<select id="searchMode">
<option value="both">å˜èªï¼‹è¨³èª</option>
<option value="name">å˜èªå</option>
<option value="information">å†…å®¹</option>
<option value="variation">å¤‰åŒ–å½¢</option>
</select>
<button onclick="searchWords()">æ¤œç´¢</button>
<pre id="searchResult"></pre>

<script>
const apiBase='https://zpdic.ziphil.com/api/v0';
function getHeaders(){return {'Content-Type':'application/json','X-Api-Key':document.getElementById('apiKey').value};}

// æ´¾ç”Ÿãƒ«ãƒ¼ãƒ«ç®¡ç†
function saveRuleset(){
  const name=document.getElementById('rulesetName').value.trim();
  if(!name)return alert('åå‰å¿…è¦');
  const rules=document.getElementById('derivationRules').value.trim().split('\n').filter(Boolean);
  const sets=JSON.parse(localStorage.getItem('derivationRulesets')||'[]');
  const existing=sets.find(s=>s.name===name);
  if(existing)existing.rules=rules;
  else sets.push({name,rules});
  localStorage.setItem('derivationRulesets',JSON.stringify(sets));
  alert('ä¿å­˜å®Œäº†');
  renderRulesets();
}
function renderRulesets(){
  const sets=JSON.parse(localStorage.getItem('derivationRulesets')||'[]');
  const sel=document.getElementById('rulesetSelect');
  sel.innerHTML='';
  sets.forEach(s=>{
    const opt=document.createElement('option');
    opt.textContent=s.name;
    sel.appendChild(opt);
  });
}
function loadRuleset(){
  const sel=document.getElementById('rulesetSelect');
  if(!sel.value)return;
  const sets=JSON.parse(localStorage.getItem('derivationRulesets')||'[]');
  const found=sets.find(s=>s.name===sel.value);
  if(found)document.getElementById('derivationRules').value=found.rules.join('\n');
}
function deleteRuleset(){
  const sel=document.getElementById('rulesetSelect');
  if(!sel.value)return;
  let sets=JSON.parse(localStorage.getItem('derivationRulesets')||'[]');
  sets=sets.filter(s=>s.name!==sel.value);
  localStorage.setItem('derivationRulesets',JSON.stringify(sets));
  renderRulesets();
}

// æ´¾ç”Ÿå‡¦ç†ï¼ˆé€æ¬¡ï¼‰
function applyRules(text,rules){
  let res=text;
  for(const rule of rules){
    const [from,to]=rule.split('â†’').map(s=>s.trim());
    if(from)res=res.replace(new RegExp(from,'g'),to);
  }
  return res;
}

async function runDerivation(){
  const inId=document.getElementById('inputDict').value.trim();
  const outId=document.getElementById('outputDict').value.trim();
  const [start,end]=document.getElementById('wordRange').value.trim().split('-').map(Number);
  const rules=document.getElementById('derivationRules').value.trim().split('\n').filter(Boolean);

  if(!inId||!outId||isNaN(start)||isNaN(end)||rules.length===0){
    alert('ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  for(let i=start;i<=end;i++){
    document.getElementById('progress').textContent=`${i-start+1} / ${end-start+1} å‡¦ç†ä¸­ï¼ˆå˜èªç•ªå·: ${i}ï¼‰`;

    try{
      const res=await fetch(`${apiBase}/dictionary/${inId}/word/${i}`,{headers:getHeaders()});
      if(!res.ok){
        document.getElementById('progress').textContent+=`\nå˜èª${i}ã®å–å¾—å¤±æ•—(${res.status}) ã‚¹ã‚­ãƒƒãƒ—`;
        continue;
      }
      const w=(await res.json()).word;

      const newName=applyRules(w.name,rules);
      const newPron=applyRules(w.pronunciation||'',rules);
      const newInfos=(w.informations||[]).map(inf=>({title:applyRules(inf.title,rules),text:applyRules(inf.text,rules)}));

      const body={word:{
        name:newName,pronunciation:newPron,
        equivalents:w.equivalents,
        tags:w.tags,
        informations:newInfos,
        variations:w.variations,
        relations:w.relations
      }};

      const postRes=await fetch(`${apiBase}/dictionary/${outId}/word`,{
        method:'POST',
        headers:getHeaders(),
        body:JSON.stringify(body)
      });
      if(postRes.ok){
        document.getElementById('progress').textContent+=`\nå˜èª${i}æ´¾ç”Ÿå®Œäº†`;
      }else{
        document.getElementById('progress').textContent+=`\nå˜èª${i}æ´¾ç”Ÿå¤±æ•—(${postRes.status})`;
      }
    }catch(e){
      document.getElementById('progress').textContent+=`\nå˜èª${i}å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ ã‚¹ã‚­ãƒƒãƒ—`;
      console.error(e);
    }

    await new Promise(r=>setTimeout(r,500)); // æ¬¡ã®å˜èªã¾ã§å¾…æ©Ÿ
  }

  alert('âœ… æ´¾ç”Ÿå‡¦ç† å®Œäº†');
}

// å˜èªç·¨é›†ãƒ»æ¤œç´¢
async function submitWord(){
  const dict=document.getElementById('inputDict').value.trim();
  const id=document.getElementById('editWordNumber').value.trim();
  const method=id?'PUT':'POST';
  const path=id?`/word/${id}`:'/word';
  const infos=document.getElementById('editInformations').value.trim().split('\n').map(l=>{const[t,x]=l.split('|');return{title:t?.trim(),text:x?.trim()}});
  const body={word:{
    name:document.getElementById('editWordName').value.trim(),
    pronunciation:document.getElementById('editPronunciation').value.trim(),
    equivalents:[],tags:document.getElementById('editTags').value.split('|').filter(Boolean),
    informations:infos,
    variations:document.getElementById('editVariations').value.split('|').filter(Boolean).map(n=>({name:n})),
    relations:[]
  }};
  const res=await fetch(`${apiBase}/dictionary/${dict}${path}`,{method,headers:getHeaders(),body:JSON.stringify(body)});
  alert(res.ok?'âœ… å®Œäº†':'âŒ ã‚¨ãƒ©ãƒ¼ '+res.status);
}
async function loadWord(){
  const dict=document.getElementById('inputDict').value.trim();
  const id=document.getElementById('editWordNumber').value.trim();
  if(!id)return;
  const res=await fetch(`${apiBase}/dictionary/${dict}/word/${id}`,{headers:getHeaders()});
  if(!res.ok)return alert('å¤±æ•—');
  const w=(await res.json()).word;
  document.getElementById('editWordName').value=w.name;
  document.getElementById('editPronunciation').value=w.pronunciation||'';
  document.getElementById('editTags').value=w.tags.join('|');
  document.getElementById('editVariations').value=w.variations.map(v=>v.name).join('|');
  document.getElementById('editInformations').value=w.informations.map(i=>i.title+'|'+i.text).join('\n');
  document.getElementById('wordResult').textContent=JSON.stringify(w,null,2);
}
async function deleteWord(){
  const dict=document.getElementById('inputDict').value.trim();
  const id=document.getElementById('editWordNumber').value.trim();
  if(!id)return;
  const res=await fetch(`${apiBase}/dictionary/${dict}/word/${id}`,{method:'DELETE',headers:getHeaders()});
  alert(res.ok?'âœ… å‰Šé™¤':'âŒ ã‚¨ãƒ©ãƒ¼');
}
async function searchWords(){
  const dict=document.getElementById('inputDict').value.trim(),text=document.getElementById('searchText').value.trim();
  const mode=document.getElementById('searchMode').value;
  const res=await fetch(`${apiBase}/dictionary/${dict}/words?text=${encodeURIComponent(text)}&mode=${mode}&type=part&limit=100`,{headers:getHeaders()});
  if(!res.ok)return alert('æ¤œç´¢å¤±æ•—');
  const js=await res.json();
  document.getElementById('searchResult').textContent=JSON.stringify(js.words||js,null,2);
}

renderRulesets();
</script>
</body>
</html>
